# This Yaml Document has been converted by ESAI Yaml Pipeline Conversion Tool.
# Please make sure to check all the converted content, it is your team's responsibility to make sure that the pipeline is still valid and functions as expected.
# The Task 'PublishBuildArtifacts@1' has been converted to an output named 'Publish Artifact BuildLogs' in the templateContext section.
parameters:
  dependsOn: []
  PublishRidAgnosticPackagesFromJobName: ''
jobs:
- job: PrepareSignedArtifacts
  displayName: Prepare Signed Artifacts
  dependsOn: ${{ parameters.dependsOn }}
  timeoutInMinutes: 120
  workspace:
    clean: all
  templateContext:
    outputs:
    - output: pipelineArtifact
      displayName: 'Publish Artifact BuildLogs'
      condition: succeededOrFailed()
      targetPath: '$(Build.StagingDirectory)\BuildLogs'
      artifactName: Logs-PrepareSignedArtifacts
  steps:
  - ${{ if and(ne(variables['System.TeamProject'], 'public'), notin(variables['Build.Reason'], 'PullRequest')) }}:
    - task: NuGetAuthenticate@1
    - task: MicroBuildSigningPlugin@2
      displayName: Install MicroBuild plugin for Signing
      inputs:
        signType: $(SignType)
        zipSources: false
        feedSource: https://dnceng.pkgs.visualstudio.com/_packaging/MicroBuildToolset/nuget/v3/index.json
      condition: and(succeeded(), in(variables['SignType'], 'real', 'test'))
  - task: DownloadBuildArtifacts@0
    displayName: Download IntermediateUnsignedArtifacts
    inputs:
      artifactName: IntermediateUnsignedArtifacts
      downloadPath: $(Build.SourcesDirectory)\artifacts\PackageDownload
  - script: >
      build.cmd -ci -projects $(Build.SourcesDirectory)\src\publish\prepare-artifacts.proj -c Release /p:PublishRidAgnosticPackagesFromJobName=${{ parameters.PublishRidAgnosticPackagesFromJobName }} /p:SignType=$(SignType) /p:DotNetSignType=$(SignType) /bl:$(Build.SourcesDirectory)\prepare-artifacts.binlog
    displayName: Prepare artifacts and upload to build
  - task: CopyFiles@2
    displayName: Copy Files to $(Build.StagingDirectory)\BuildLogs
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)'
      Contents: |
        **/*.log
        **/*.binlog
      TargetFolder: '$(Build.StagingDirectory)\BuildLogs'
    continueOnError: true
    condition: succeededOrFailed()